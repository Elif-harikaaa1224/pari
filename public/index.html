<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PariVision - –°—Ç–∞–≤–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav>
        <div class="container">
            <h1>üéØ PariVision</h1>
            <div class="nav-links">
                <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="/bridge">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</a>
                <a href="/markets">–ú–∞—Ä–∫–µ—Ç—ã</a>
                <a href="/my-bets">–ú–æ–∏ —Å—Ç–∞–≤–∫–∏</a>
            </div>
            <button id="connectBtn" class="btn btn-primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
        </div>
    </nav>

    <main class="container">
        <section class="hero">
            <h2>–î–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è —Å –ø–æ–º–æ—â—å—é BNB</h2>
            <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ MetaMask, –ø–æ–ø–æ–ª–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ BSC –∏ –¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫–∏ –Ω–∞ Polymarket</p>
        </section>

        <div id="walletInfo" class="wallet-info" style="display: none;">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—à–µ–ª—å–∫–µ</h3>
            <div class="info-grid">
                <div class="info-card">
                    <label>–ê–¥—Ä–µ—Å:</label>
                    <div id="walletAddress" class="mono">-</div>
                </div>
                <div class="info-card">
                    <label>–ë–∞–ª–∞–Ω—Å BNB (BSC):</label>
                    <div id="bnbBalance" class="mono">-</div>
                </div>
                <div class="info-card">
                    <label>–ü—Ä–æ–∫—Å–∏-–∫–æ—à–µ–ª–µ–∫ (Polygon):</label>
                    <div id="proxyAddress" class="mono">-</div>
                    <button id="setCustomProxy" class="btn-link" style="font-size: 0.75rem; margin-top: 0.5rem; display: block;">–£–∫–∞–∑–∞—Ç—å —Å–≤–æ–π –∞–¥—Ä–µ—Å</button>
                </div>
                <div class="info-card">
                    <label>–ë–∞–ª–∞–Ω—Å USDC (Polygon):</label>
                    <div id="usdcBalance" class="mono">-</div>
                </div>
            </div>

            <div class="action-buttons">
                <a href="/bridge" class="btn btn-success">–ü–æ–ø–æ–ª–Ω–∏—Ç—å —á–µ—Ä–µ–∑ BNB</a>
                <a href="/markets" class="btn btn-primary">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–∞—Ä–∫–µ—Ç—ã</a>
                <a href="/my-bets" class="btn btn-secondary">–ú–æ–∏ —Å—Ç–∞–≤–∫–∏</a>
            </div>
        </div>

        <div id="notConnected" class="not-connected">
            <h3>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞</h3>
            <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É</p>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script src="/js/config.js"></script>
    <script src="/js/wallet.js"></script>
    <script>
        // Initialize on page load
        window.addEventListener('load', async () => {
            console.log('Page loaded, checking ethers...');
            if (typeof ethers === 'undefined') {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ethers.js. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            console.log('Ethers loaded:', ethers.version);
            
            await initWallet();
            await checkConnection();
            
            // Setup event listeners after page load
            setupEventListeners();
        });

        function setupEventListeners() {
            // Connect button handler
            const connectBtn = document.getElementById('connectBtn');
            if (connectBtn) {
                connectBtn.addEventListener('click', async () => {
                    try {
                        await wallet.connect();
                        await checkConnection();
                    } catch (error) {
                        console.error('Connection error:', error);
                        alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
                    }
                });
            }

            // Set custom proxy button
            const setProxyBtn = document.getElementById('setCustomProxy');
            if (setProxyBtn) {
                setProxyBtn.addEventListener('click', async () => {
                    const customProxy = prompt('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ –ø—Ä–æ–∫—Å–∏-–∫–æ—à–µ–ª—å–∫–∞ —Å Polymarket.com:\n\n–ù–∞–ø—Ä–∏–º–µ—Ä: 0x871046Dd7808147DE9640619Ab974F09A7922548');
                    
                    if (!customProxy) return;
                    
                    if (ethers.utils.isAddress(customProxy)) {
                        wallet.proxyAddress = customProxy;
                        localStorage.setItem('customProxyAddress', customProxy);
                        document.getElementById('proxyAddress').textContent = 
                            `${customProxy.slice(0, 6)}...${customProxy.slice(-4)}`;
                        alert('‚úÖ –ü—Ä–æ–∫—Å–∏-–∞–¥—Ä–µ—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                        await loadWalletInfo();
                    } else {
                        alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∞–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞!');
                    }
                });
            }
        }

        async function checkConnection() {
            const isConnected = await wallet.isConnected();
            
            if (isConnected) {
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('notConnected').style.display = 'none';
                document.getElementById('connectBtn').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚úì';
                document.getElementById('connectBtn').disabled = true;
                
                // Load wallet info
                await loadWalletInfo();
            } else {
                document.getElementById('walletInfo').style.display = 'none';
                document.getElementById('notConnected').style.display = 'block';
            }
        }

        async function loadWalletInfo() {
            try {
                const address = await wallet.getAddress();
                document.getElementById('walletAddress').textContent = 
                    `${address.slice(0, 6)}...${address.slice(-4)}`;

                // Load BNB balance
                try {
                    const bnbBalance = await wallet.getBNBBalance();
                    document.getElementById('bnbBalance').textContent = 
                        `${parseFloat(bnbBalance).toFixed(4)} BNB`;
                } catch (e) {
                    console.error('Error loading BNB balance:', e);
                    document.getElementById('bnbBalance').textContent = '–û—à–∏–±–∫–∞';
                }

                // Get proxy address
                const proxyAddress = await wallet.getProxyAddress();
                document.getElementById('proxyAddress').textContent = 
                    `${proxyAddress.slice(0, 6)}...${proxyAddress.slice(-4)}`;

                // Load USDC balance
                try {
                    const usdcBalance = await wallet.getUSDCBalance(proxyAddress);
                    document.getElementById('usdcBalance').textContent = 
                        `${parseFloat(usdcBalance).toFixed(2)} USDC`;
                } catch (e) {
                    console.error('Error loading USDC balance:', e);
                    document.getElementById('usdcBalance').textContent = '0.00 USDC';
                }
            } catch (error) {
                console.error('Error loading wallet info:', error);
            }
        }
    </script>
</body>
</html>